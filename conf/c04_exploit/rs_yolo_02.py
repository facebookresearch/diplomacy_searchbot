import json
import getpass
import pathlib

import numpy as np
import pandas as pd

import heyhi.gsheets
import heyhi.run

import run


THIS_FILE = pathlib.Path(__file__).resolve()
THIS_DIR = THIS_FILE.parent


COMMON = {
    "rollout.num_rollout_processes": 160,
    "rollout.inference_batch_size": 32,
    "optimizer.grad_clip": 1.0,
}

REDEFINES = [
    {},
    {"rollout.max_rollout_length": 100, "rollout.block_size": 5,},
    {"rollout.max_rollout_length": 100, "rollout.block_size": 1, "rollout.rebatch_size": 512,},
    {"rollout.max_rollout_length": 200, "rollout.block_size": 2,},
    {"rollout.max_rollout_length": 200, "rollout.block_size": 1, "rollout.rebatch_size": 512,},
    {
        "rollout.max_rollout_length": 200,
        "rollout.block_size": 1,
        "rollout.rebatch_size": 512,
        "discounting": "0.95",
    },
    {
        "rollout.max_rollout_length": 200,
        "rollout.block_size": 1,
        "rollout.rebatch_size": 512,
        "delay_penalty": 1e-3,
    },
    {
        "rollout.max_rollout_length": 200,
        "rollout.block_size": 1,
        "rollout.rebatch_size": 512,
        "optimizer.lr": 1e-9,
    },
]


def loguniform(rng, low, high):
    low, high = min(low, high), max(low, high)
    return np.exp(rng.uniform(np.log(low), np.log(high)))


def redefines_from_dict(redefines):
    chunks = []
    for k, v in redefines.items():
        chunks.append(f"{k}={v}")
    return chunks


def yield_sweep():
    cfg = THIS_DIR / "exploit.prototxt"
    for redefines in REDEFINES:
        redefines = dict(**redefines)
        redefines["I.launcher"] = "slurm_pascal"
        redefines.update(COMMON)
        yield cfg, redefines


def get_logs_data(handle):
    metrics = {k: None for k in ["epoch", "reward/last", "loss/critic", "loss/entropy"]}
    result_path = handle.exp_path / "metrics.jsonl"
    if not result_path.exists():
        return metrics
    data = []
    with result_path.open() as stream:
        for line in stream:
            try:
                record = json.loads(line)
            except:
                break
            data.append(record)
    if not data:
        return metrics
    data = pd.DataFrame(data)

    metrics["epoch"] = data["epoch"].values.max()
    metrics["loss/critic"] = data["loss/critic"].dropna().values.min()
    if "loss/entropy" in data.columns:
        metrics["loss/entropy"] = data["loss/entropy"].dropna().values.min()
    if "reward/last" in data.columns:
        metrics["reward/last"] = data["reward/last"].dropna().values.max()
    return metrics


def main(mode, use_gsheet):
    handles = []
    sheet_file = "fairdip/%s" % THIS_DIR.name
    sheet_name = "%s" % (THIS_FILE.name.split(".")[0])
    exp_id = "%s_%s/rs" % (THIS_DIR.name, sheet_name)
    for cfg, override_dict in yield_sweep():
        h = heyhi.run.maybe_launch(
            run.main,
            exp_root=heyhi.run.get_exp_dir(heyhi.run.PROJECT_NAME),
            overrides=redefines_from_dict(override_dict),
            cfg=cfg,
            mode=mode,
            exp_id_pattern_override=f"%(prefix)s/{exp_id}_%(redefines)s_%(redefines_hash)s",
        )
        handles.append((h, override_dict))
    df = []
    col_order = {}
    for (h, od) in handles:
        datum = {}
        datum["status"] = str(h.get_status())
        datum.update(get_logs_data(h))
        datum.update(od)
        col_order.update(datum)
        # Not adding these feilds to col_order to out them at the end.
        datum["exp_id"] = h.exp_id.split("/")[-1].replace("sweep@launcher@slurm@", "")
        datum["job_id"] = h.maybe_get_job_id()
        datum["folder"] = h.exp_path
        df.append(datum)
    if df:
        # Puting meta fields to the col order.
        col_order.update(df[0])
        df = pd.DataFrame(df, columns=list(col_order))
        # df = df.sort_values("job_id")
        if use_gsheet:
            heyhi.gsheets.save_pandas_table(df, sheet_file, sheet_name, offset=1)
        del df["folder"]
        print(df.head(50).to_string(index=False))


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser()
    parser.add_argument("--mode", choices=heyhi.MODES, default="gentle_start")
    parser.add_argument("--use_gsheet", type=int, default=int("yolo" == getpass.getuser()))
    main(**vars(parser.parse_args()))
